name: Build Android APK with Rust

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # 1. 设置 Java 环境 (用于 Gradle)
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 2. 设置 Rust 环境
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: aarch64-linux-android # 针对现代主流安卓手机 (ARM64)
        override: true

    # 3. 安装 cargo-ndk (帮助编译 .so)
    - name: Install cargo-ndk
      run: cargo install cargo-ndk

    # 4. 安装 Android NDK
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c

    # 5. 编译 Rust 库 (.so)
    - name: Build Rust Library
      working-directory: ./
      # 编译 arm64-v8a 架构。如果需要兼容旧手机，可以增加 armv7-linux-androideabi
      run: |
        cargo ndk -t aarch64-linux-android -o ./android/app/src/main/jniLibs build --release

    # 6. 赋予 Gradle 执行权限
    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    # 7. 编译 Debug APK
    - name: Build with Gradle
      working-directory: ./android
      run: ./gradlew assembleDebug

    # 8. 上传生成的 APK
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: iching-app-debug
        path: android/app/build/outputs/apk/debug/app-debug.apk
